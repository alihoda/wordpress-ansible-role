#jinja2: trim_blocks: "true", lstrip_blocks: "true"
{{ ansible_managed | comment }}
# Generated by Ansible role {{ ansible_role_name }}

server {
  listen 443 ssl;
  listen [::]:443 ssl;

  server_name {{ registry_domain }}; 

  include snippets/ssl-certs.conf;

  client_max_body_size {{ nginx_registry_client_max_body_size }};

  location / {
    if ($http_user_agent ~ "^(docker\/1\.(3|4|5(?!\.[0-9]-dev))|Go ).*$" ) {
      return 404;
    }
  
    proxy_pass http://registry:{{ docker_registry_config_http_port }};
    
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  
    proxy_read_timeout 900;
  }
}

server {
  listen 80;

  server_name {{ registry_domain }}; 

  return 301 https://$host$request_uri;
}
